김일성종합대학학보 정보과학 주체108(2019)년 제65권  제3호 uC/OS-II에 기초한 매몰형망통신모듈의 실현 리광식, 문명옥 론문에서는 자원을 절약하고 크기를 작게 하는 망통신모듈을 제공하기 위하여 uC/OS-II실시간조작체계를 이식한데 기초하여 이써네트조종기 ENC28J60과 uIP규약에 기 초한 매몰형 TCP/IP규약통신모듈을 설계하고 실현하였다. １．uC/OS-II핵심의 이식 uC/OS-II는 원천이 공개된 다중과제실시간체계로서 국제적인 인정을 받은 극소형핵심 이며 안정성이 비교적 높은 환경에서 사용할수 있다. 많은 응용부분에서 uC/OS-II는 극소 형조종기에 이식되여 실시간조종체계[3]로 되고있다. uC/OS-II의 코드원천화일은 웃층의 응용프로그람과 련관된 배치화일, 처리기와 무관 계한 핵심기능실현화일과 처리기와 관련한 이식화일로 나눌수 있다.(그림 1) 응용프로그람 응용프로그람관련 OS_CFGH INCLUDE.H 처리기와 무관계 OS_CORE.C          OS_Q.C OS_FLAG.C OS_MBOX.C OS_MEM.C OS_MUTEX.C OS_SEM.C OS_TASK.C OS_TIME.C OS_TMG.C 처리기관련 OS_CPU.H,  OS_CPU_A.ASM,  OS_CPU.C 그림 1. uC/OS-II화일구조 uC/OS-II이식과정은 다음과 같다. ① OS_CPU.H에서 번역기와 관련한 자료류형, 마크로정의 및 탄창자료류형을 정의 ② OS_CPU.C에서 탄창초기화함수 및 응용프로그람에서 사용되여야 하는 일련의 한다. Hook함수를 실현한다. uC/OS-II에 기초한 매몰형망통신모듈의 실현 － 21 － ③ 아쎔블리언어를 사용하여 OS_CPU_A.ASM에서 처리기중단의 열기/닫기기능, 과제 절환함수 및 박자중단을 실현한다. 실현하며 망통신과제를 설계한다. uC/OS-II핵심을 이식한 후 그에 기초하여 TCP/IP탄창을 창조하고 망구동프로그람을 ２．ENC28J60구동프로그람 ENC28J60은 표준직렬외부장치결합부(SPI)를 리용하며 속도는 10Mbps이다. 또한 IEEE 802.3규약에 부합되며 프로그람가능한 려파기능과 8KB 두 통로 SRAM완충기를 가지고 있다. ENC28J60은 28핀의 이써네트조종기로서 SPI결합부를 사용하여 4선으로 극소형조종 기와 호상 련결된다. PHY와 MAC를 내장하여 매우 편리하게 배치를 완성할수 있다. 그리 하여 작은 망통신모듈에서 ENC28J60[3]이 비교적 합리적인것으로 선택된다. ENC28J60원리도는 그림 2와 같다. 3.3V 49Ω×4 3.3V RESET  10 NET_CS  9 INT  4 NET_WOL  5 WRI_MISO  6 WRI_MOSI  7 WRI_SCK  8 RESET CS INT WOL SO SI SCK 3.3V 0.1pF 25MHz 20pF×2 GND GND 25 23 24 22 14 1 3 VDDOSC OSC1 OSC2 VSSOSC RBIAS VCAP CLKOUT 1kΩ 10µF LEDB LEDA TPIN- TPIN+ TOUT- TOUT+ 26 27 12 13 16 17 VDD VDDTX VDDPLL VDDRX VSSTX VSSPLL VSSPRX VSS 28 15 20 19 18 21 11 2 HR911105A 1 2 3 4 6 9 10 11 12 TD+ TD- RD+ VCC RD+ L+ L- R- R+ 1kΩ×2 13 ETH GND 0.1µF×4 GND GND ENC28J60 GND 그림 2. ENC28J60원리도 １）ENC28J60소편초기화 어떠한 소편도 사용전에 초기화조작을 걸쳐야 하며 ENC28J60도 례외가 아니다. uC/OS-II의 과제설계에서 소편의 초기화과제는 처리기의 재설정후에 준비되여 즉시 완성 되여야 하며 필요할 때에만 조절하여야 한다. 초기화는 수신완충기, 송신완충기, 수신려파 기, MAC초기화 및 PHY의 초기화를 수행한다. ２）자료전송프로그람 자료전송과정에 ENC28J60은 안내프레임경계지정을 자동생성하는 기능을 가지고있다. 만일 사용자가 요구한다면 ENC28J60도 CRC코드를 자동생성하는데 사용자가 대응한 배 치를 진행하여야 한다. 자료전송전에 처리기는 반드시 전송하려는 모든 자료프레임을 전 － 22 － 종합대학학보 정보과학 주체108(2019)년 제65권 제3호 송완충기에 넣어야 한다. 그리고 처리기도 반드시 자료전송패키쥐를 전송하기 전에 자료 패키쥐조종바이트를 추가하여야 한다. 자료패키쥐바이트는 몇개의 단 즉 PHUGEEN, PPADEN, PCRCEN 및 POVERRIDE으로 구성되여있다. ３）자료수신프로그람 자료수신프로그람은 우선 중단표기를 검사하여 자료패키쥐를 수신하였는가를 검증하 여야 한다. 만일 수신되였다면 주조종기는 RBM SPI지령을 사용하여 다음 패키쥐지적자의 머리부주소로부터 읽기를 시작한다. ３．uIP규약 uIP규약[1, 2]은 콤파일후 코드크기와 실행할 때 요구되는 RAM크기가 다른 일반적인 TCP/IP규약보다 작은것으로 하여 기억공간에 예민한 매몰형체계에서 많이 응용되고있다. 그리하여 uC/OS실시간핵심을 이식한 체계에 ENC28J60과 uIP규약에 기초한 매몰형망통신 모듈을 만드는것은 경제적일뿐아니라 실용적이며 보통의 매몰형응용의 요구를 만족할수 있다. uIP규약은 콤파일완성후 몇천바이트의 ROM만을 차지하며 실행할 때에는 몇백바이트 의 RAM만 있으면 된다. 였다. uIP규약은 TCP/IP규약종류의 4개 기본규약 ARP, IP, ICMP 및 TCP규약만을 실현하 련결층규약 례하면 PPP는 uIP아래의 장치구동으로 실현할수 있다. 응용층규약 HTTP, FTP 혹은 SMTP는 uIP상의 응용프로그람으로 실현할수 있다. uIP규약은 체계가 제공한 함수의 코드서고로 볼수 있다.  그림 3에 uIP결합부를 보여주었다. 응용프로그람 UIP_APPCALL() uIP uip_input() uip_periodie() 체계 망구동프로그람 주기 Timer 그림 3. uIP결합부 체계아래층의 각도에서 보면 uIP는 체계아래층이 제공한 3개 함수인데 각각 uip_init(), uip_input()와 uip_periodie()이다. uip_init()는 uIP통신탄창을 초기화하는 기능을 실현하였으며 체계가 기동하는 초기에 uC/OS-II에 기초한 매몰형망통신모듈의 실현 － 23 － 반드시 이 함수를 리용하여 uIP규약탄창에 대한 초기화동작을 완성하여야 한다. uIP규약탄창과 체계아래층 ENC28J60구동프로그람교환자료의 기본적인 구조는 대역변 수 uip_buf(C언어에서는 실제로 하나의 배렬)이다. ENC28J60구동프로그람이 수신한 자료 패키쥐를 uip_buf완충기에 써넣을 때 체계는 즉시 uip_input()함수를 사용한다. 이 함수가 실행이 끝나서 귀환할 때 출력패키쥐를 uip_buf에 써넣는다. 패키쥐의 크기는 다른 대역 변수 uip_len에 의하여 표시된다. 만일 대역변수 uip_len의 값이 0이면 전송하여야 할 자료 패키쥐가 없다는것을 나타낸다. uip_ periodie()함수는 모든 uIP규약탄창내부의 박자사건을 구동하는데 리용한다. 이미 만들어진 매개 TCP련결에 대하여 uip_ periodie()를 사용하여야 한다. 그중에서 uip_ periodie()함수에 전달하는 파라메터는 TCP련결의 련결번호이다. 이 함수는 uip_input()와 류사한데 진행이 끝나서 귀환할 때 출력패키쥐를 완충기 uip_buf에 써넣어야 한다. 응용프로그람의 견지에서 출발하면 응용프로그람은 반드시 uIP에 귀환함수를 제공하 여야 한다. 망 혹은 시간설정사건이 발생할 때 uIP는 귀환함수를 리용한다. 자료접수, 다 른쪽에로의 자료전송이 성공, 새로운 련결의 창조, 자료재전송을 요구하는 등의 사건이 발생할 때 uIP는 응용프로그람이 제공하는 귀환함수만을 사용한다. 그밖에 주기적으로 창 조되는 매개 련결을 순환하면서 검사하며 새로운 자료가 도착할 때 중단방식을 리용하여 처리를 진행한다. ４．실험 및 결과분석 우선 PC로부터 ping지령으로 개발장치를 통과할수 있는가를 검사한다. PC의 지령창에 서 ping지령을 사용하여 개발장치를 련결할 때 개발장치의 귀환정보를 받는다. 다음 PC 에서 망도구를 리용하여 개발장치와 TCP련결을 진행하고 UDP통신을 진행한다. 현실적조건에 맞게 수신포구로 새로운 UDP자료패키쥐가 도달할 때 련결표안의 IP 와 포구정보가 수신한 UDP패키쥐의 IP와 포구정보와 일치하지 않는것으로 하여 통신이 중단되는 문제를 프로그람적으로 해결하는 방법을 제안하고 실현함으로써 통신의 믿음 성을 높이였다. 론문에서 설계하고 실현한 매몰형망통신블로크는 소형체계에서 응용할수 있으며 PC 와 매몰형체계에 대한 원격조종을 실현할수 있다. 맺 는 말 참 고 문 헌 [1] Ricardo Moraes; Computer Standards and Interfaces[J], 33, 3, 5, 2011. [2] J. Santos; IEEE Conferences, 17, 9, 1, 2009. [3] N. Medrano; IEEE Communication Surveys & Tutorlals, 17, 1, 10, 2015. 주체108(2019)년 5월 5일 원고접수 － 24 － 종합대학학보 정보과학 주체108(2019)년 제65권 제3호 Implementation of Embedded Network Communication  Modules by uC/OS-II Ri Kwang Sik, Mun Myong Ok In the paper we inject uC/OS-II real-time OS to support network communication modules which save resource and make small and design and implement Ethernet Controller ENC28J60 and uIP based embedded TCP/IP Protocol communication module. Key words: uC/OS-II, embedded network communication module, ENC28J60