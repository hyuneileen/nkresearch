김일성종합대학학보 정보과학 주체107(2018)년 제64권  제2호 QorIQ한소편처리기에서 IPMI통신을 진행하기 위한 I2C장치 Linux구동프로그람구성의 한가지 방법 김수일, 성철령 경애하는 최고령도자 동지께서는 다음과 같이 말씀하시였다. 《정보통신부문에서는 그 우월성이 확증된 IP망으로 통신기반을 전반적으로 갱신하고 전국적범위로 확대하며 고정통신과 이동통신을 통합하여 그 응용능력과 편리성, 효과성을 최대로 높이도록 하여야 합니다.》 다음세대통신망의 개발에서 기간망통신설비의 믿음성과 안전성을 보장하는 문제는 매우 중요하게 나서고있다. 이 문제를 해결하기 위하여 제안된 ATCA, MTCA와 같은 원격통신콤퓨터구성방식에 서는 하드웨어기반관리(Hardware Platform Management)라는 장치관리방식을 리용하고있으 며 여기서는 IPMI통신규약에 따라 매 모듈들과 수감부들사이에 IPMB통보문의 송수신을 진행한다. IPMI통신규약은 I2C통신방식의 한가지 수단이다. Linux에서 가동하는 하드웨어기반관리쏘프트웨어는 I2C장치구동프로그람을 리용하여 다른 모듈(AMC, 전원, 랭각단 등)들과 통신한다. 이때 송신하는 IPMB통보문은 모든 IPMB마디점들에서 항상 주조종기쓰기방식으로 진행되며 IPMB통보문을 받기 위해서는 종속수신방식에서 동작하여야 한다. 그러나 많은 Linux용I2C장치구동프로그람[2]들은 주조종기의 쓰기/읽기방식에서만 동작하도록 구성되여 있다. 론문에서는 ARM Cortex-A7기반의 한소편처리기인 QorIQ에서 Linux용I2C장치구동프로 그람을 주조종기 및 종속방식에서도 동작할수 있도록 설계하였다. １．Linux에서 I2C장치구동프로그람의 구조 I2C(Inter Integrated Circuit)모선[1]은 두선식직렬모선규격으로서 한소편처리기와 그 주 변장치들을 련결하고 조종하는데 많이 리용된다. I2C장치[1, 2]는 Linux에서 하나의 문자형장치로 본다. 이 구동프로그람[1]은 Linux의 통일적인 장치대면부를 리용하며 /dev/i2c-x화일을 통하 여 I2C장치의 열기, 닫기, 읽기/쓰기, ioctl 등의 기능을 실현한다. I2C구동프로그람과 장치의 대응관계는 그림 1과 같다. I2C모선장치구동프로그람은 장치조종을 위하여 다음의 구조를 정의하고있다. ① i2c_adapter: I2C모선분배기이다. 대응되는 장치는 한소편처리소자모선에서 확장한 ② i2c_algorithm: I2C모선통신전송알고리듬이다. I2C모선조종기를 관리하며 I2C모선자료 I2C조종기이다. － 14 － 종합대학학보 정보과학 주체107(2018)년 제64권 제2호 의 송신, 수신 등의 조작을 실현한다. 사용자응용프로그람 I2C 주조종기구동프로그람 (i2c-dec.c) I2C 종속장치구동프로그람 I2C 핵심부구동프로그람 (i2c-core.c) I2C 구동기관리 (i2c-drive.c) I2C 알고리듬 (i2c-algorithm) I2C 분배기 (i2c-adapter) I2C 종속장치구동 (i2c-client) I2C 주조종기 I2C 종속장치 I2C 모선 그림 1. I2C구동프로그람과 장치의 대응관계 ③ i2c_driver: I2C장치구동프로그람을 관리하는데 리용되며 I2C의 장치마디점에 대응 된다. I2C모선을 구동하는 방식은 소자마다 다르므로 해당 한소편처리기의 설계방식에 따 라 주조종기방식과 종속방식을 모두 지원하는 구동프로그람을 설계해야 한다. 또한 대부분의 I2C Linux장치구동프로그람은 다른 I2C종속방식의 소자들과 통신하기 위하여 설계되여있으므로 주조종기방식에서의 통신만 구현되여있으며 종속방식에서의 통 신이 구현된 처리기에서는 중단처리함수안에서 다른 주조종기에서 보낸 자료들의 처리를 모두 진행하므로 IPMI통신과 같이 임의의 시각에 대량으로 들어오는 자료를 처리할 때 자료손실이 발생하는 결함을 가지고있다. ２．QorIQ LS1021A에서 Linux I2C구동프로그람의 설계 ARM Cortex-A7기반의 2중핵심부한소편처리기인 QorIQ계렬의 LS1021A는 망통신설비 분야에 리용하기 위한 목적으로 설계된 처리기이다. 이 처리기는 영상처리용보조처리기와 여러가지 고속 및 저속통신조종기들을 가지고있다. 그중 I2C조종기는 3개이며 매 조종기 들의 내부등록기에는 주소지정방식으로 접속할수 있다. QorIQ한소편처리기의 I2C조종기는 내부의 주소등록기, 박자분배등록기, 모선조종등록 기, 모선상태등록기, 자료입출력등록기, 모선중단구성등록기들을 통하여 I2C통신을 진행하 QorIQ한소편처리기에서 IPMI통신을 진행하기 위한 I2C장치 … － 15 － 며 이 등록기들에 대한 접근은 ARM처리기의 관리자방식에서만 진행할수 있다. 자료의 입출력시에 발생하는 중단처리의 흐름은 그림 2와 같다. 시작 IBIF 재설정 주동방식 종속방식 주동/종속 방식? 예 송신 아니 끝바이트 읽기 예 아니 아니 끝바이트 수신? 예 아니 RXAK=0 아니 예 주소의 끝 아니 Rx 방식 절환 다음바이트를 IBDR 에 쓰기 예 예 마지막 2 번째 바이트 읽기 아니 NOACK =1 정지 신호 발생 IBDR 읽기 정지신호 발생 IBDR 자료저장 중재 실패? 아니 예 IAAS 아니 송신끝 아니 예 IBAL 재설정 IAAS = 1 ? 예 SRW= 1? 예 아니 예 다음 바이트 송신 Tx 방식 설정 Rx 방식 설정 IBDR 자료 쓰기 IBDR 자료 읽기 예 ACK 아니 Rx 방식 절환 IBDR 자료 읽기 IRDR 자료저장 중단탈퇴 끝 그림 2. 자료의 입출력시에 발생하는 중단처리의 흐름 － 16 － 종합대학학보 정보과학 주체107(2018)년 제64권 제2호 I2C주조종기방식에서는 ARM계렬의 다른 한소편처리기의 I2C장치구동프로그람에서와 류사한 방식으로 자료의 송신을 진행한다. I2C종속방식에서는 주조종기로부터 보낸 자료의 수신을 통지하기 위하여 중단처리를 리용한다. 그러므로 주조종기로부터 전송되는 자료를 받기 위하여 i2c-imx.c화일의 중단처 리함수인 i2c_imx_isr함수와 읽기함수인 i2cdev_read에 아래의 순서에 맞게 코드를 추 가한다. ① 먼저 I2C조종기의 주소등록기에 종속방식으로 동작할 때 가지는 주소를 설정한다. (주소등록기의 8번째 비트는 읽기/쓰기용으로 예약되여있는데 이것을 고려하여 해당한 값 을 주어야 한다.) ② 다음으로 조종등록기 IMDIS비트를 설정하여 I2C모듈을 리용할수 있게 한다. ③ 상태등록기의 IAAS비트와 SRW비트에 따라 조종등록기의 TXRX를 설정한다. ④ 상태등록기의 IBIF비트를 0으로 설정하여 다음번 중단이 있을 때 해당한 기발이 설정되도록 한다. ⑤ 자료등록기에 대한 거짓읽기를 하여 들어오는 자료를 받을수 있게 한다. ⑥ 1B전송이 끝날 때까지 기다린다. 상태등록기의 IBIF비트가 1로 될 때까지 기다린다. ⑦ 상태등록기의 TCF비트(1B전송완료), IBB(Bus 상태)비트값을 읽고 상태를 결정한다. ⑧ 자료등록기값을 보관하고 상태등록기의 IBB비트가 0이 될 때(자료전송완료)까지 ④부터 해당 순환을 진행한다. IPMI통신규약에 따라 수신되는 자료처리를 모두 중단함수안에서 진행하면 자료손실 이 일어날수 있다. 특히 MTCA구성방식의 통신장치에서 모듈들이 추가되면 자료송수신의 실패률은 더 높아진다. 그리하여 중단함수에서는 Linux체계핵심부가 제공하는 workqueue 형식의 과제대기렬에 대한 자료의 쓰기만 진행하며 이 자료에 대한 처리는 따로 생성한 스레드에서 함으로써 자료송수신의 정확성을 보장하였다. 받은 자료를 사용자공간으로 보내기 위한 사용자공간과 핵심부공간사이의 대면[3]은 i2c-dev.c화일의 읽기, 쓰기, ioctl을 통하여 실현되는데 이 프로그람에서는 해당한 자료를 넘겨주기 위하여 읽기함수를 리용한다. 사용자공간에서는 읽기함수를 호출하고 이 함수호출이 종속수신인 경우인가를 판정 하며 이때 핵심부공간에서는 과제대기렬의 스레드를 호출하여 새로 읽은 자료가 있으면 그 자료를 읽는다. 론문에서는 QorIQ한소편처리기에서 I2C통신을 위한 Linux장치구동프로그람을 새롭게 작성하여 IPMI통신을 실현함으로써 기간망통신설비의 관리를 진행할수 있게 하였다. 맺 는 말 참 고 문 헌 [1] 전봉찬 등; Linux장치구동프로그람개발법, 과학기술출판사, 27～47, 주체99(2010). [2] 채혁기 등; Linux에 의한 매몰형체계설계, 공업출판사, 86～96, 주체97(2008). QorIQ한소편처리기에서 IPMI통신을 진행하기 위한 I2C장치 … － 17 － [3] P. S. Tschudin et al.; Proceedings of the 7th Workshop on Programming Languages and Operating Systems, 705, 2013. 주체107(2018)년 2월 5일 원고접수 A Method of Configuring the Linux I2C Device Driver for IPMI  Communication in QorIQ Microprocessor Kim Su Il, Song Chol Ryong In this paper we configured I2C Linux driver of QorIQ ARM microprocessor which supported master and slave modes so as to implement the IPMI communication in the MTCA telecommunication apparatus. Key words: Linux device driver, I2C, IPMI, QorIQ microprocessor