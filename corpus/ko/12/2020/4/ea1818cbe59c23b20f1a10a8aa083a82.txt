김일성종합대학학보 정보과학 주체109(2020)년 제66권  제4호 STM32에 의한 블루투스통신실현의 한가지 방법 리 광 식 위대한 령도자 동지께서는 다음과 같이 교시하시였다. 《정보산업을 빨리 발전시키고 인민경제의 모든 부문을 정보화하여야 합니다. 정보기 술발전계획을 똑똑히 세우고 정보기술발전사업을 국가의 가장 중요한 사업으로 틀어쥐고 나가야 합니다.》(《선집》 증보판 제20권 380페지) 무선기술은 설치, 유지보호, 갱신 등이 편리한것으로 하여 널리 리용되고있다. 이러 한 무선기술에는 주요하게 IEEE 802.11, HomeRF, 블루투스(BlueTooth)가 있다. 여기서 IEEE 802.11에 기초한 무선망은 원가가 비교적 높으며 HomeRF는 개방성이 좋지 못하다. 블루투스는 포괄범위가 작은 무선통신기술표준이지만 에네르기소비가 적고 원가가 낮으 며 간단하고 리용이 편리한 우점을 가지고있다.[2] 론문에서 ARM Cortex-M3을 핵심으로 하는 STM32처리기와 HC05를 리용하여 블루투 스통신을 실현하는 한가지 방법을 제기하였다. １．체 계 구 성 １）HC05블루투스모듈소개 HC05모듈은 고성능주종속일체화블루투스직렬모듈로서 블루투스기능을 가진 여러가 지 콤퓨터, 블루투스장치, 손전화기, PDA 등 지능말단장치와 접속을 할수 있다. 이 모듈 은 매우 넓은 보드속도범위(4 800～1 382 400bps)를 지원하며 5V 혹은 3.3V 한소편체계를 다 받아들이므로 여러 장치들과 편리하게 련결을 진행할수 있다. 그리고 리용이 매우 유 연하고 편리하다.[1] HC05모듈은 매우 작고 정교하며(16mm×32mm) 6개의 2.54mm간격의 배치단자를 통하여 외부장치와 련결한다. HC05모듈의 매 단자에 대한 기능설명을 표 1에 보여주었다. 표 １．HC05모듈의 매 단자에 대한 기능설명 단자번호 이름 설 명 접속상태출력: 접속이 성공하면 높은 준위를 출력하며 그렇지 않으면 낮 은 준위를 출력한다. AT상태진입에 리용한다. 높은 준위가 유효이다. 직렬수신단자로서 한소편의 TXD와 련결할수 있다. 이때 TTL준위, RS232 준위와 직접 련결하지 말아야 한다. 직렬송신단자로서 한소편의 RXD와 련결할수 있다. 이때 TTL준위, RS232준위와 직접 련결하지 말아야 한다. 접지 전원(3.3～5.0V) 그밖에 모듈은 자체로 상태지시등 STA를 가지고있다. 이 상태지시등은 세가지 상태 1 2 3 4 5 6 LED KEY RXD TXD GND VCC 를 나타낸다. STM32에 의한 블루투스통신실현의 한가지 방법 － 93 － ① 모듈에 전원이 투입되는것과 동시에 KEY를 높은 준위(VCC에 련결)로 설정하면 STA는 천천히 깜빡이는데(1s에 한번 깜빡임.) 모듈은 AT상태로 들어가며 그때 보드속도 는 38 400으로 고정된다. ② 모듈에 전원이 공급된 후 KEY를 띄여놓거나 GND에 련결하면 STA는 빨리 깜빡 이는데(1s에 두번 깜빡임.) 모듈이 접속상태로 들어갈수 있다는것을 나타낸다. 만일 이때 KEY를 다시 높은 준위로 하면 모듈도 AT상태로 들어가지만 STA는 여전히 빠르게 깜빡 인다. ③ 모듈의 접속이 성공하면 STA는 두가지 형식으로 깜빡인다.(2s에 한번 깜빡임.) STA지시등이 있음으로 하여 모듈의 현재상태를 편리하게 판단할수 있고 리용을 편 리하게 한다. 한편 HC05블루투스직렬모듈의 모든 기능은 AT지령묶음을 통하여 조종한다. HC05블루투스직렬모듈을 통하여 임의의 한소편장치(3.3V/5V전원)는 블루투스통신을 편리하게 실현할수 있으므로 콤퓨터, 손전화기, 판형콤퓨터 등을 포함하여 각종 블루투스 장치와 련결할수 있다. ２）장치구성 체계가 실현하여야 할 기능은 다음과 같다. 장치가 기동하면 HC05블루투스모듈이 있는가를 검사하고 검사에 성공하지 못하면 오유통보를 낸다. 그리고 검사가 성공하면 모듈의 주종속상태와 모듈이 련결상태에 있는 가를 표시해준다. 이때 LED0이 깜빡이면 프로그람이 정상동작한다는것을 의미한다. 한편 KEY0건을 눌러 자동자료전송을 열거나 닫는다. 그리고 WK_UP건을 눌러 모듈 의 주종속상태를 절환할수 있다. 블루투스모듈이 수신한 자료는 직접 LCD에 표시한 다.(ASCII문자표시만을 지원) 동시에 USART를 통하여 HC05블루투스모듈에 대하여 AT지 령검색과 설정을 진행할수 있다. 또한 손전화기말단블루투스쏘프트웨어를 결합하여 손전 화기무선조종을 실현할수 있다. 이러한 기능을 수행하기 위한 체계구성도를 그림에 보여주었다. 그림. 체계구성도 － 94 － 종합대학학보 정보과학 주체109(2020)년 제66권 제4호 HC05블루투스모듈과 STM32와의 련결관계를 표 2에 보여주었다. 표 ２．HC05블루투스모듈과 STM32와의 련결관계 장치이름 대응하는 포구 ATK-HC05블루투스모듈 VCC GND TXD RXD KEY LED 3.3V/5V GND PA3 PA2 PC4 PA4 STM32 표 2에서 HC05블루투스직렬모듈의 VCC는 개발기판의 3.3V전원이나 5V전원에도 련 결할수 있으므로 편리한대로 자기가 선택한다. 블루투스모듈의 모든 기능을 검사하기 위하여 표 2에서 6개 선으로 련결하였는데 실 제리용에서는 AT설정진입과 상태지시가 필요없다면 4개 선 즉 VCC/GND/TXD/RXD만 있 으면 된다. ３）쏘프트웨어구성 여기에서는 앞에서 설명한 설계요구를 실현하기 위한 프로그람설계를 진행한다. STM32처리기의 직렬포구 1(PC와의 통신)과 직렬포구 2(HC05모듈과의 통신)를 리용 하므로 그 처리를 위한 프로그람을 작성한다. 우선 련속적으로 수신하는 2개 바이트사이의 시간차이가 10ms보다 작다는 판단을 통하여 련속적인 자료인가를 결정한다. 만일 2개 바이트수신시간이 10ms를 초과하면 한차례의 련속적인 자료가 아닌것으로 본다. 다시말하여 10ms를 초과하여 임의의 자료도 수신하지 못하였다면 이 수신이 완성 된것으로 판단한다. 다음 직렬포구 2의 초기화 및 직렬포구 2의 송신 및 수신처리를 위한 코드를 실현한다. 직렬포구 2에서는 DMA를 리용하여 송신을 실현함으로써 체계의 실시간성을 높였다. 직렬포구 2의 자료수신은 시간설정기의 판단방식으로 리용한다. 한차례의 련속적인 수신 자료에 대하여 만일 련속 10ms동안에 아무런 자료도 받지 못하면 이번 자료수신이 끝난 것으로 판단한다. 다음 직렬포구 1의 초기화 및 송수신처리를 위한 코드를 실현한다. 여기서는 PC와의 직렬통신을 실현한다. 대표적인 함수들의 기능을 보면 다음과 같다. ① HC05_Init함수 이 함수는 HC05와 련결하는 IO포구를 초기화하는데 리용하며 AT지령을 통하여 HC05블루투스모듈이 련결되였는가 하는것을 검사한다. ② HC05_Get_Role함수 이 함수는 HC05블루투스모듈의 주종속상태를 얻는데 리용한다. 여기에서는 AT+ROLE?지령을 통하여 모듈의 주종속상태를 얻는다. ③ HC05_Set_Cmd함수 이 함수는 ATK-HC05블루투스모듈의 일반설정지령으로서 이 함수를 호출하여 HC05 블루투스직렬모듈의 여러가지 설정을 편리하게 수정할수 있다. ④ HC05_CFG_CMD함수 이 함수는 USART검사모듈을 위하여 전문적으로 제공한것으로서 USART를 리용하여 HC05블루투스직렬모듈의 AT지령을 검사하며 USART검사가 필요하지 않을 때에는 이 함 수를 없앨수 있다. STM32에 의한 블루투스통신실현의 한가지 방법 － 95 － ２．검 증 실 험 실험에서는 2개의 HC05블루투스모듈이 호상접촉을 한 다음 1개의 HC05블루투스모 듈과 손전화기를 련결하고 손전화기를 통하여 장치의 LED조종을 진행하였다. 우선 2개 HC05블루투스모듈의 호상련결을 보면 이 2개의 모듈의 접속은 매우 간단 하다. HC05모듈의 기정상태는 Slave상태이므로 다른 하나의 HC05모듈에 전원을 넣은 후 WK_UP건을 눌러 장치에 있는 HC05모듈을 주장치(Master)로 설정한다. 그러면 약간 대기 후 2개의 HC05모듈들은 자동적으로 련결되며 동시에 액정현시기에 Connected가 표시된 다. 이때 2개의 블루투스모듈의 STA지시등이 두가지로(2s마다 두번 깜빡임.) 깜빡이며 선 련결이 성공하였다는것을 나타낸다. 직렬포구도구(종속블루투스에 련결)를 통하여 장치로 자료를 전송하는데 장치에서 보내는 자료를 수신할수도 있다. 직렬포구도구의 전송기능을 리용하여 자료를 전송하면 장치의 LCD에 종속장치로 전 송하여온 자료를 표시한다. 다음 HC05와 손전화기사이의 실험을 진행하였다. 우선 손전화기와 편리하게 련결하기 위하여 블루투스모듈을 종속으로 설정한다. 그리고 손전화기에 블루투스쏘프트웨어를 설치한다. 다음 이 쏘프트웨어를 열어 블 루투스장치탐색대면부로 들어간다. 손전화기가 장치의 모듈을 탐색하였다면 그것을 눌러 선택조작방식으로 들어가는데 이때 건반방식을 선택한다. 다음 암호를 입력하여 접속을 완성한다. 암호를 입력하면 일 정한 시간대기후 련결이 성공되였다는것을 알린다. 주함수에서는 《+LED1 ON》 혹은 《+LED1 OFF》문자를 수신하였는가에 대한 판단을 통하여 LED1에 대한 조종을 진행한다. 그러므로 2개 건반의 전송내용을 각각 《+LED1 ON》과 《+LED1 OFF》로 설정하면 LED1의 조종을 실현할수 있다. 설정을 완성한 후 손전화기를 통하여 장치의 LED1을 조종할수 있으며 동시에 이 쏘 프트웨어는 장치로부터 오는 자료를 수신할수 있다. 이상의 실험을 통하여 설계한 장치에 대한 블루투스통신의 믿음성을 확정하였다. STM32F103처리기와 HC05를 리용한 블루투스통신을 실현할수 있는 장치를 설계하였 다. 설계한 장치에서는 블루투스통신뿐아니라 상위PC와의 통신을 위한 결합부를 설계하 여 장치가 독립적인 블루투스장치로 동작하면서 PC와 련결된 장치로도 동작할수 있게 하였다. 또한 AT지령을 통한 블루투스장치사이의 통신을 보장하는 쏘프트웨어를 작성하 고 실험을 통하여 설계한 하드웨어 및 쏘프트웨어가 설계요구에 맞게 정확하게 동작한다 는것을 확증하였다. 맺 는 말 참 고 문 헌 [1] Fang Zi Zheng; Electronic Design Engineering, 15, 26, 163, 2018. [2] M. T. Delgado at al.; Preprint Submitted to Journal of Biosensors & Bioelectronics, 3, 1, 2018. 주체109(2020)년 8월 5일 원고접수 － 96 － 종합대학학보 정보과학 주체109(2020)년 제66권 제4호 A Method for Implementation of Bluetooth Communication with STM32 Ri Kwang Sik In this paper an implementation of bluetooth communication with STM32 whose core is ARM Cortex-M3 and HC05 is proposed. Keywords: bluetooth, serial communication, HC05