김일성종합대학학보 (자연과학) JOURNAL OF KIM IL SUNG UNIVERSITY (NATURAL SCIENCE) 주체106(2017)년 제63권 제2호 Vol. 63 No. 2  JUCHE106(2017). FPGA와 MCU사이 직렬통신체계실현의 한가지 방법 김 운 봉 지난 시기에는 말단수감부에 한소편콤퓨터를 설치하여 한소편콤퓨터들사이 그리고 한소편콤퓨터와 상위콤퓨터사이 자료전송을 진행하였다.[1, 2] 현재 프로그람문배렬소자인 FPGA를 리용하여 장치를 실현하는 방향으로 나가고있다. 이로부터 론문에서는 프로그람 문배렬소자인 FPGA를 리용하여 한소편콤퓨터 MCU와의 FPGA사이 자료전송을 실현하는 체계구축에서 제기되는 문제를 론의하였다. FPGA와 MCU사이 직렬통신체계를 실현하기 위해서는 두가지 문제 즉 FPGA에서의 RS-232직렬통신체계실현문제와 MCU에서의 직렬통신체계실현문제가 해결되여야 한다. FPGA와 MCU사이 직렬통신장치구성도는 그림과 같다. 그림. FPGA와 MCU사이 직렬통신장치구성도 먼저 FPGA직렬통신체계에 대하여 보자. FPGA는 Cyclon II계렬의 EP2C5T144C8N을 리용하였다. FPGA로 Nios II체계를 구축하기 위하여 20MHz발진기와 FLASH기억기, SDRAM기억 기를 리용하였다. 그리고 전송과정현시를 위해 16×2 LCD현시기를 리용하였으며 RS-232 통신결합소자로서 MAX232를 리용하였다. FPGA를 리용한 직렬통신체계를 구축하기 위하여 SOPC Builder를 리용하여 Nios II체 계를 구축한다. 이를 위하여 먼저 SOPC Builder로 Nios II/f를 생성하고 SDRAM과의 접속 을 위한 SDRAM대면조종부를 생성한다. 다음 FLASH와의 신호접속을 위한 EPCS대면부 를 생성한다. 다음 LCD대면을 위한 병렬주변장치들인 LCD소편선택대면부 LCD_CS, LCD 읽기/쓰기조종대면부인 LCDR_W, LCD자료모선 LCDDB대면부를 생성한다. 마지막으로 RS-232직렬통신대면부로서 UART조종대면부를 생성한다. 이 UART조종대 면부는 MAX232변환기를 통하여 COM포구와 접속된다. － 50 － 종합대학학보(자연과학)   주체106(2017)년  제63권  제2호 한편 Nios체계에 공급될 박자발생기를 생성해야 하는데 장치적으로는 20MHz 발진기 를 설계하였으므로 MegaWizard가 지원하는 PLL을 리용하여 20MHz로부터 100MHz의 박 자를 얻어낸다. 작성된 FPGA직렬통신하드웨어모형을 Quartust에서 콤파일하여 장치에 내리적재할 sof 화일을 생성한다. Nios II SBT에서 진행한다. 이에 기초하여 직렬통신을 위한 Nios프로그람을 작성한다. Nios프로그람은 개발환경 프로그람은 크게 main함수와 driver함수, 머리부화일로 구성된다. main함수에서는 uart초기화와 lcd초기화를 진행한다. uart조종함수들은 uart의 driver함수에서 정의한다. 여기에는 uart초기화함수와 보드설정 함수, 직렬중단처리함수, 직렬자료전송함수가 정의되여있다. 우선 uart초기화함수 uart.initialize()는 보드설정함수 set_baudrate로 보드속도를 9 600으 로 설정하고 uart조종부의 상태등록기를 초기화하며 직렬전송중단처리함수를 등록하는데 그 프로그람은 다음과 같다. int uart_initialize(){ set_baudrate(9 600); UART->CONTROL.BITS.IRRDY=1; UART->STATUS.WORD=0; alt_irq_register(UART_IRQ, NULL, uart_ISR); return 0;} 다음 직렬중단처리함수 uart_interrupt()는 직렬자료수신때 발생되는 중단에 대한 처리 즉 수신자료를 적재하는 기능을 수행하는 함수로서 직렬수신준비검사에 기초하여 직렬수 신완충기에 수신된 자료를 적재하고 수신완충기의 빔상태를 검사하며 해당한 상태기발을 설정한다. 즉 직렬자료수신은 직렬중단처리함수를 리용하여 1B의 직렬자료를 수신할 때 마다 중단이 발생되게 하며 이때 직렬중단처리함수에 의해 직렬자료를 수신하여 완충기 에 적재하게 되는데 그 프로그람은 다음과 같다. static void uart_interrupt (void){ while(!(UART->STATUS.BITS.TRDY)); uart.receive_buffer[uart.receive_count++] = UART->RXDATA.BITS.RECEIVE_DATA; if(uart.receive_buffer[uart.receive_count－1]=='\n'){ uart.receive_buffer[uart.receive_count]='\0';   끝으로 직렬자료전송은 자료전송함수 uart_transfer에 의해 수행된다. 이 함수에서는 uart.receive_count=0; uart.receive_flag=1;}} 전송할 자료를 송신완충기에 적재하고 송신기발 trdy가 설정될 때까지 대기한다. 송신기발이 설정되면 송신이 진행되였으므로 송신처리를 끝내는데 그 프로그람은 다 음과 같다. int uart_transfer(unsigned char data){ UART->TXDATA.BITS.TRANSMIT_DATA = data; while(!(UART->STATUS.BITS.TRDY)); return 0;} FPGA와 MCU사이 직렬통신체계실현의 한가지 방법 － 51 － 한편 작성된 프로그람은 Nios II BST에서 콤파일하여 내리적재할 ELF화일을 생성 한다. FPGA직렬통신장치의 하드웨어내리적재화일과 프로그람내리적재화일을 Programmer를 리용하여 FLASH에 내리적재한다. 내리적재가 완성되면 FPGA는 AS방식으로 FLASH에 적재된 하드웨어화일과 프로그람화일을 적재하여 MCU와의 직렬통신을 진행하게 된다. 다음으로 MCU직렬통신체계를 보자. MCU로서 ATMEGA8L을 리용하는데 ATMEGA8L은 모든 단자들이 다중정의되여있다. 즉 재설정단자와 박자발생단자, 직렬입출력단자들이 모두 자기기능외에 병렬I/O단자기능 도 수행하게 되여있다. 재설정단자기능수행을 위해 RSTDISBL휴즈비트를 1로 설정하고 외부수정편발생기설 정을 위해 CKSEL3-CKSEL1휴즈비트를 111로 설정한다. 그리고 8MHz 발진을 위해 CKOPT휴즈비트를 1로 설정하며 빠른 기동시간보장을 위해 CKSEL0휴즈비트는 1로, SUT1휴즈비트는 0, SUT0휴즈비트는 1로 설정한다. 이에 기초하여 MCU직렬통신프로그람 을 개발환경 CodeVisionAVR에서 작성한다. 프로그람에서 먼저 등록기들에 대한 초기설정을 진행한다. USART조종 및 상태등록기 UCSRA는 수신완성때 중단설정을 위해 RXC비트를 1로 즉 80H로 설정한다. USART조종 및 상태등록기 UCSRB는 수신완성때 중단처리를 위해 RXCIE비트를 1로, 수신가능을 위해 RXEN비트를 1로, 송신가능을 위해 TXEN비트를 1로 즉 UCSRB등록기는 98H로 설정한다. USART조종 및 상태등록기 UCSRC는 비동기방식선택을 위해 UMSEL비트를 0으로, 홀수기우성검사를 위한 기우성비트추가를 위해 UPM1, UPM0비트를 각각 1로, 1개의 정 지비트추가를 위해 USBS비트를 0으로, 8bit 자료전송을 위해 UCSZ1, UCSZ0비트를 각각 1로 설정한다. 따라서 UCSRC등록기는 00110011(33H)로 설정된다. USART보드속도등록기 UBRRH와 UBRRL은 8MHz 박자에서 9 600bps의 보드속도를 보장하기 위해 10진수로 51, 16진수로 0033H를 설정한다. 다음 자료송신은 송신완충기 UDR의 빔상태를 조사하여 1 즉 비여있다면 송신자료등 록기 UDR에 송신자료를 적재한다. UDR의 자료를 수신변수에 대입한다. 자료수신은 수신기발 RXC가 설정되였는가를 검사하고 설정되여있다면 수신완충기 MCU직렬통신프로그람은 개발환경 CodeVisionAVR에서 콤파일하며 여기서 얻어진 HEX화일을 TOP에서 ATMEGA8L에 내리적재하면 MCU직렬통신체계가 완성된다. 맺 는 말 Cyclon II FPGA와 ATMEGA8L MCU사이 직렬통신체계를 구축하고 RS-232직렬통신 을 실현하였다. 이를 위해 FPGA주변장치를 구성하고 FPGA에서 직렬통신을 위한 Nios하 드웨어 및 프로그람체계를 개발도구를 리용하여 구축하였으며 MCU직렬통신장치를 구성 하고 직렬통신을 위한 MCU프로그람을 작성하였다. － 52 － 종합대학학보(자연과학)   주체106(2017)년  제63권  제2호 참 고 문 헌 [1] 종합대학학보(자연과학), 61, 6, 22, 주체104(2015). [2] Kristian Saether; Introducing a New Breed of Microcontrollers for 8/16-bit Applications, Atmel Corporation, 1～15, 2008. 주체105(2016)년 10월 5일 원고접수 A Method for Realizing the Serial Communication between FPGA and MCU Kim Un Bong So far MCU was set on the terminal sensor unit to transfer the data between MCUs, and MCU and one-chip computer. And now programmable gate array(FPGA) is being used. This paper described the method how to resolve a problem arising in building the system to realize data communication between MCU and FPGA in system with FPGA. Key words: FPGA, MCU